

```{r}
.libPaths('/data/gpfs/projects/punim2121/R_libs/4.2.1')
.libPaths()
```


```{r}
#BiocManager::install('muscat')
library(DESeq2)
library(muscat)
library(SingleCellExperiment)
library(zellkonverter)
```


# Determine marker genes of Leiden-clusters of scVI-batch corrected data

## 1. For each Leiden-cluster do:
## 2. Calculate Pseudo-bulk counts (sum counts per each patient)
## 3. Split __sce__ object into 2 datasets: cells in Leiden-clust vs. rest
## 4. Merge the created datasets' counts and create a "coldata" dataframe for creating a design matrix later
## 5. Perform DGE with DESeq2 between Leiden-cluster cells vs. rest, controlling for "patient" as batch effect

```{r}

## Function for searching cluster marker genes
get_leiden_marker_genes=function(dat,leiden_clust_colname,coldata,col_to_sum_by,cols_to_correct_for){
  
  ## Init list for collecting results
  de_result_list=list()
  
  ## Loop over the Leiden-clusters
  for (leiden_clust in unique(sort(dat@colData[,leiden_clust_colname]))){
    print(paste0('Leiden cluster:',leiden_clust))
    
    
    ### Split SCE object into cells of Leiden-cluster vs. rest
    leid_clust_dat=dat[,dat@colData[,leiden_clust_colname]==leiden_clust]
    rest_dat=dat[,dat@colData[,leiden_clust_colname]!=leiden_clust]
    
    
    ## Sum the cells per each patient, creating a pseudo-bulk dataset of num_genes x num_patients
    leid_clust_pb=aggregateData(leid_clust_dat, assay="raw_counts", fun='sum', by=c(col_to_sum_by))
    rest_pb=aggregateData(rest_dat, assay="raw_counts", fun='sum', by=c(col_to_sum_by))
    
    ## Add suffix to colnames, indicating where the data comes from (cluster or rest dataset)
    leid_clust_pb_coln=paste(colnames(assay(leid_clust_pb)), "_clust", sep = "")
    rest_pb_coln=paste(colnames(assay(rest_pb)), "_rest", sep = "")
    
    ## Reorder coldata to align with count data
    coldata_clust=coldata[colnames(assay(leid_clust_pb)),]
    coldata_rest=coldata[colnames(assay(rest_pb)),]
    
    
    
    ### Concatenate the two count datasets (cluster and rest) + update its colname
    contr_data=cbind(assay(leid_clust_pb),assay(rest_pb))
    contr_data_coln=c(leid_clust_pb_coln,rest_pb_coln)
    colnames(contr_data)=contr_data_coln

    
    ### Concatenate the coldata as well for the clust and rest samples
    contr_data_coldata=rbind(coldata_clust,coldata_rest)
    rownames(contr_data_coldata)=contr_data_coln
    
    
    
    ## Add column indicating origin of data (clust or rest) + set rest as level 0
    contr_data_coldata[,'contrast']=c(rep('clust',length(leid_clust_pb_coln)),
                                          rep('rest',length(rest_pb_coln)))
    contr_data_coldata$contrast=factor(contr_data_coldata$contrast, levels=c('rest','clust'))
    
    ## Convert character columns to factors
    #cols_to_factors=cols_to_correct_for
    #contr_data_coldata[, cols_to_factors] <- lapply(contr_data_coldata[, cols_to_factors], factor)
    
    ## Reorder coldata's rows to match the merged count matrix's columns (pre-requisite for DESeq2)
    contr_data_coldata=contr_data_coldata[colnames(contr_data),]
    

    
    ### Perform DGE and extract results
    design_form=as.formula(paste(c(~1,cols_to_correct_for,'contrast'),collapse='+')) 
    dge=DESeqDataSetFromMatrix(contr_data, colData=contr_data_coldata, 
                                #design=~1+batch+patient+preparation_kit+contrast)
                               design=design_form)
    dds=DESeq(dge)
    res=results(dds, contrast=c("contrast","clust","rest"))
    deseq_out=as.data.frame(res@listData, row.names = res@rownames)
    
    
    df=deseq_out[,c("log2FoldChange","pvalue","padj")]
    df$gene=rownames(deseq_out)
    colnames(df)=c("log2FC","pvalue","padj","gene")
    df[,'cluster']=leiden_clust
    
    ## Extract only significant genes (FDR<0.05) + sort by most significant
    df=df[(!is.na(df$padj)),] #(df$padj<0.05)&
    df=df[order(df$padj),]
    
    ## Add result to result list
    de_result_list[[leiden_clust]]=df
  }
  
  return (de_result_list)  
}



## Run marker gene function
#colnames(dat@colData)

proc_dir='/data/gpfs/projects/punim2121/Atherosclerosis/xenium_data/processed_data/baysor_processed_output/'
scale_param='10'
avg_assignment_conf_thr='0.75'

for (panel in c('Panel1','Panel2')){
  print(panel)
  
  ## Load Panel adata
  fn=paste0(proc_dir,'filtered_',panel,'_cells_scale_',scale_param,'_asg_conf_',avg_assignment_conf_thr,'.h5ad')
  adata=zellkonverter::readH5AD(file=fn,reader='python')

  meta=adata@colData
  
  ## Create a coldata dataframe containing the batch effect descriptors
  coldata=aggregate(x=meta[,c('patient','condition')],
                               by=list(original_sample=meta$original_sample),FUN=unique)
  rownames(coldata)=coldata$original_sample
  
  ## Define parameters of DESeq
  leiden_clust_colname='leiden_merged'
  col_to_sum_by='original_sample'
  cols_to_correct_for=c('patient','condition')
  
  marker_df_list=get_leiden_marker_genes(adata,leiden_clust_colname,coldata,col_to_sum_by,cols_to_correct_for)
  
  ## Use do.call to apply rbind to the list of data frames
  concatenated_df <- do.call(rbind, marker_df_list)
  
  ## Reset rownames
  rownames(concatenated_df) <- NULL
  
  ## Save concatenated data frame
  deseq2_dirname=paste0(proc_dir,'dge_deseq2/')
  
  # Check if the DEseq2 result dir exists, If it doesn't exist, create it
  if (!dir.exists(deseq2_dirname)) {
    dir.create(deseq2_dirname)}
  
  fname=paste0(panel,'_leiden_clust_marker_genes.csv.gz')
  file_path=paste0(deseq2_dirname,fname)
  write.csv(concatenated_df,file=file_path)
}
```

## Volcano plots of differentially expressed genes

```{r echo=FALSE,fig.width=8,fig.height=10}

proc_dir='/data/gpfs/projects/punim2121/Atherosclerosis/xenium_data/processed_data/baysor_processed_output/'
library(dplyr)
library(ggplot2)
library(ggrepel)
library(cowplot)


### log2FC threshold for DE
log2FC_thr=1


for (panel in c('Panel1','Panel2')){
  print(panel)
  ## Load concatenated data frame
  deseq2_dirname=paste0(proc_dir,'dge_deseq2/')
  fname=paste0(panel,'_leiden_clust_marker_genes.csv.gz')
  file_path=paste0(deseq2_dirname,fname)
  dge_df=read.csv(file_path)
  
  ## Set the thresholds for significantly differentially expressed genes
  dge_df <- dge_df %>% 
                  dplyr::mutate(threshold_dge=padj < 0.05 & abs(log2FC)>=log2FC_thr)
  
  ## List for collecting individual ggplots and plot hthem in a grid in the end
  plotlist=list()
  
  for (leiden_clust in unique(dge_df$cluster)){
    clust_df=dge_df[dge_df$cluster==leiden_clust,]
    
    ## Add new column to collect the differentially expressed gene names
    clust_df[,'DE_gene_names']=''
    clust_df[(clust_df$padj < 0.05) & abs(clust_df$log2FC)>=log2FC_thr,'DE_gene_names']=clust_df[(clust_df$padj < 0.05) & abs(clust_df$log2FC)>=log2FC_thr,'gene']

    p=ggplot(clust_df, aes(x = log2FC, y = -log10(padj))) +
            geom_point(aes(colour = threshold_dge),size=1) +
            geom_text_repel(aes(label = DE_gene_names)) +
            geom_vline(xintercept=log2FC_thr,linetype="dotdash") +
            geom_vline(xintercept=-log2FC_thr,linetype="dotdash") +
            geom_hline(yintercept=-log10(0.05),linetype="dotdash") + 
            ggtitle(paste0(panel,' - Cluster ',leiden_clust,' vs. rest')) +
            xlab("log2 fold change") + 
            ylab("-log10 adjusted p-value") +
            theme(legend.position = "none",
                  plot.title = element_text(size = rel(1.5), hjust = 0.5),
                  axis.title = element_text(size = rel(1.25))) 
    #print(p)
    ## Collect ggplot to list (add+1 to leiden_clust, as R does not recognize 0 as a valid index in a list ==> cluster 0 won't get plotted)
    plotlist[leiden_clust+1]=list(p)
  }
  print(plot_grid(plotlist=plotlist,ncol=3))
}

```

### LOAD MARKER GENES FROM COLLABORATORS AND FROM LITERATURE

```{r}
library("rjson")
library(dplyr)
proc_dir='/data/gpfs/projects/punim2121/Atherosclerosis/xenium_data/processed_data/baysor_processed_output/'

marker_gene_list=list()

for (gene_dict_orig in c('marker_genes_from_collaborator','marker_genes_from_literature')){
  json_file_path=paste0(proc_dir,gene_dict_orig,'.json')
  json_data=fromJSON(file=json_file_path)
  marker_gene_list[[gene_dict_orig]]=json_data
} 



### log2FC threshold for DE
log2FC_thr=1

celltype_results=list()

for (panel in c('Panel1','Panel2')){
  print(panel)
  
  ## Load concatenated data frame
  deseq2_dirname=paste0(proc_dir,'dge_deseq2/')
  fname=paste0(panel,'_leiden_clust_marker_genes.csv.gz')
  file_path=paste0(deseq2_dirname,fname)
  dge_df=read.csv(file_path)
  
  ## Set the thresholds for significantly differentially expressed genes
  dge_df <- dge_df %>% 
                  dplyr::mutate(threshold_dge=padj < 0.05 & abs(log2FC)>=log2FC_thr)
  
  d=sapply(unique(dge_df$cluster),function(x) NULL)
  
  for (leiden_clust in unique(dge_df$cluster)){
    clust_df=dge_df[dge_df$cluster==leiden_clust,]
    
    d[[as.character(leiden_clust)]]=list()
    
    ## Add new column to collect the differentially expressed gene names
    clust_df[,'DE_gene_names']=NA
    clust_df[(clust_df$padj<0.05)&(clust_df$log2FC)>=log2FC_thr,'DE_gene_names']=clust_df[(clust_df$padj<0.05)&(clust_df$log2FC)>=log2FC_thr,'gene']
    
  
    clust_mark_genes=unlist(clust_df[!is.na(clust_df$DE_gene_names),'DE_gene_names'])
    
    
    
    
    for (gene_dict_orig in names(marker_gene_list)){
      marker_gene_dict=marker_gene_list[[gene_dict_orig]]
      
      d[[as.character(leiden_clust)]][[gene_dict_orig]]=list()
      
      for (cell_type in names(marker_gene_dict)){
        clust_pos_mark_genes=intersect(clust_mark_genes,unlist(marker_gene_dict[cell_type]))
        #print(paste0(clust_mark_genes,marker_gene_dict[cell_type]))
        if (length(clust_pos_mark_genes)>0){
          d[[as.character(leiden_clust)]][[gene_dict_orig]][[cell_type]]=clust_pos_mark_genes
        }
        
      }
      #print(clust_mark_genes)
    }
  }
  celltype_results[[panel]]=d
}

```

